<!-- ToDify弹窗 -->
<div class="modal fade" id="batchToDifyModal" tabindex="-1" aria-labelledby="batchToDifyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="batchToDifyModalLabel">推送到Dify知识库</h5>
        <span class="ms-2 badge bg-primary" id="selectedDocsCount" style="display: none;"></span>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="batchToDifyForm">
          <input type="hidden" id="batchDifyDocumentId" name="document_id" value="">
          <input type="hidden" id="batchDifyDocumentIds" name="document_ids" value="">
          
          <div class="mb-3">
            <label for="batchDifyApiServer" class="form-label">Dify API服务器地址</label>
            <input type="text" class="form-control" id="batchDifyApiServer" value="{{ dify_api_server }}" readonly>
          </div>
          
          <div class="mb-3">
            <button type="button" class="btn btn-outline-primary w-100" id="batchTestConnectionBtn">
              <i class="fas fa-plug me-2"></i>测试连接
            </button>
          </div>
          
          <div class="mb-3">
            <label for="batchDifyKnowledgeBase" class="form-label">选择知识库</label>
            <select class="form-select" id="batchDifyKnowledgeBase" name="dataset_id" required>
              <option value="" selected disabled>请先测试连接</option>
            </select>
          </div>
        </form>
        
        <!-- 推送结果反馈 -->
        <div id="batchPushError" class="alert alert-danger mt-3" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="batchPushToDifyBtn">
          <i class="fas fa-cloud-upload-alt me-2"></i>推送
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 顶部进度条 -->
<div id="batchProgress" class="progress position-fixed top-0 start-0 w-100" style="height: 3px; z-index: 9999; display: none;">
  <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('批量ToDify模态框初始化开始');
  
  const batchToDifyModal = document.getElementById('batchToDifyModal');
  const testBtn = document.getElementById('batchTestConnectionBtn');
  const pushBtn = document.getElementById('batchPushToDifyBtn');
  const errorDiv = document.getElementById('batchPushError');
  const knowledgeBaseSelect = document.getElementById('batchDifyKnowledgeBase');
  const selectedDocsCount = document.getElementById('selectedDocsCount');
  const batchProgress = document.getElementById('batchProgress');
  
  console.log('批量ToDify元素检查:',
    '模态框:', batchToDifyModal ? '已找到' : '未找到',
    '测试按钮:', testBtn ? '已找到' : '未找到',
    '推送按钮:', pushBtn ? '已找到' : '未找到',
    '错误div:', errorDiv ? '已找到' : '未找到',
    '知识库选择器:', knowledgeBaseSelect ? '已找到' : '未找到'
  );
  
  // 弹窗事件
  batchToDifyModal.addEventListener('show.bs.modal', function(event) {
    console.log('批量ToDify模态框显示事件触发');
    
    let button = event.relatedTarget;
    
    // 处理自定义事件
    if (event.detail && event.detail.relatedTarget) {
      button = event.detail.relatedTarget;
      console.log('使用自定义事件中的触发按钮');
    }
    
    console.log('批量ToDify触发按钮属性:',
      'data-batch:', button.hasAttribute('data-batch'),
      'data-document-ids:', button.getAttribute('data-document-ids')
    );
    
    // 重置UI状态
    errorDiv.style.display = 'none';
    resetConnectionBtn();
    knowledgeBaseSelect.innerHTML = '<option value="" selected disabled>请先测试连接</option>';
    
    // 批量模式处理
    let selectedIds = [];
    
    // 尝试从button的data-document-ids获取
    if (button.hasAttribute('data-document-ids')) {
      selectedIds = button.getAttribute('data-document-ids').split(',');
    } else {
      // 从勾选框获取
      const checkboxes = document.querySelectorAll('input[name="selected_docs"]:checked');
      selectedIds = Array.from(checkboxes).map(cb => cb.value);
    }
    
    if (selectedIds.length === 0) {
      errorDiv.textContent = '请至少选择一个文档';
      errorDiv.style.display = 'block';
      setTimeout(() => {
        bootstrap.Modal.getInstance(batchToDifyModal).hide();
      }, 1500);
      return;
    }
    
    document.getElementById('batchDifyDocumentIds').value = selectedIds.join(',');
    document.getElementById('batchDifyDocumentId').value = '';
    
    // 显示选中数量
    selectedDocsCount.textContent = `已选择 ${selectedIds.length} 个文档`;
    selectedDocsCount.style.display = 'inline-block';
  });
  
  // 重置连接按钮状态
  function resetConnectionBtn() {
    testBtn.innerHTML = '<i class="fas fa-plug me-2"></i>测试连接';
    testBtn.classList.remove('btn-success', 'btn-danger');
    testBtn.classList.add('btn-outline-primary');
    testBtn.disabled = false;
  }
  
  // 测试连接
  testBtn.addEventListener('click', function() {
    console.log('批量ToDify - 测试连接按钮被点击');
    testBtn.disabled = true;
    testBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin me-1"></i>测试连接中...';
    errorDiv.style.display = 'none';
    
    fetch('/chunklab/dify/test-connection')
      .then(response => {
        console.log('测试连接响应状态码:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('测试连接响应数据:', data);
        if (data.status === 'success') {
          testBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i>连接成功';
          testBtn.classList.remove('btn-outline-primary');
          testBtn.classList.add('btn-success');
          loadKnowledgeBases();
        } else {
          showError(data.message || '连接失败');
          testBtn.innerHTML = '<i class="fas fa-times-circle me-1"></i>连接失败';
          testBtn.classList.remove('btn-outline-primary');
          testBtn.classList.add('btn-danger');
        }
      })
      .catch(error => {
        console.error('测试连接出错:', error);
        showError('连接失败: ' + error.message);
        testBtn.innerHTML = '<i class="fas fa-times-circle me-1"></i>连接失败';
        testBtn.classList.remove('btn-outline-primary');
        testBtn.classList.add('btn-danger');
      })
      .finally(() => {
        setTimeout(() => testBtn.disabled = false, 1000);
      });
  });
  
  // 加载知识库
  function loadKnowledgeBases() {
    knowledgeBaseSelect.innerHTML = '<option value="" selected disabled>加载中...</option>';
    
    fetch('/chunklab/dify/knowledge-bases')
      .then(response => response.json())
      .then(data => {
        knowledgeBaseSelect.innerHTML = '';
        
        if (data.status === 'success') {
          // 添加默认选项
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.disabled = true;
          defaultOption.selected = true;
          defaultOption.textContent = '请选择知识库';
          knowledgeBaseSelect.appendChild(defaultOption);
          
          // 添加知识库选项
          (data.data.data || []).forEach(dataset => {
            const option = document.createElement('option');
            option.value = dataset.id;
            option.textContent = dataset.name;
            knowledgeBaseSelect.appendChild(option);
          });
        } else {
          showError('获取知识库列表失败: ' + (data.message || '未知错误'));
          knowledgeBaseSelect.innerHTML = '<option value="" selected disabled>加载失败</option>';
        }
      })
      .catch(error => {
        showError('获取知识库列表失败: ' + error.message);
        knowledgeBaseSelect.innerHTML = '<option value="" selected disabled>加载失败</option>';
      });
  }
  
  // 显示错误信息
  function showError(message) {
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
  }
  
  // 使用全局的showToast函数，如果不存在，则创建一个简单版本
  const showToast = window.showToast || function(type, message) {
    console.log(`Toast ${type}: ${message}`);
    // 如果没有全局函数，使用alert作为备选方案
    if (type === 'error') {
      alert('错误: ' + message);
    } else if (type === 'success') {
      alert('成功: ' + message);
    } else {
      alert(message);
    }
  };
  
  // 显示进度条
  function showProgress() {
    batchProgress.style.display = 'block';
    batchProgress.querySelector('.progress-bar').style.width = '0%';
  }
  
  // 更新进度条
  function updateProgress(percent) {
    batchProgress.querySelector('.progress-bar').style.width = percent + '%';
  }
  
  // 完成进度条
  function completeProgress() {
    batchProgress.querySelector('.progress-bar').style.width = '100%';
    setTimeout(() => {
      batchProgress.style.display = 'none';
    }, 1000);
  }
  
  // 推送到Dify
  pushBtn.addEventListener('click', function() {
    const documentIds = document.getElementById('batchDifyDocumentIds').value;
    
    // 检查是否选择了知识库
    if (!knowledgeBaseSelect.value) {
      showError('请选择知识库');
      return;
    }
    
    // 禁用按钮并显示加载状态
    pushBtn.disabled = true;
    pushBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>推送中...';
    errorDiv.style.display = 'none';
    
    // 创建FormData并发送请求
    const formData = new FormData();
    formData.append('dataset_id', knowledgeBaseSelect.value);
    formData.append('document_ids', documentIds);
    
    // 批量模式
    const url = '/chunklab/dify/push-batch';
    showProgress(); // 显示顶部进度条
    
    // 批量推送开始时，立即更新所有选中文档的推送状态为"推送中"
    const ids = documentIds.split(',');
    ids.forEach(id => {
      updatePushStatus(id, 'pushing');
    });
    
    fetch(url, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      pushBtn.disabled = false;
      pushBtn.innerHTML = '<i class="fas fa-cloud-upload-alt me-2"></i>推送';
      
      if (data.status === 'processing') {
        // 关闭弹窗并显示全局提示
        bootstrap.Modal.getInstance(batchToDifyModal).hide();
        
        // 简单清理可能残留的背景遮罩和样式
        setTimeout(() => {
          document.body.classList.remove('modal-open');
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) backdrop.remove();
        }, 300);
        
        // 批量处理
        const totalDocs = documentIds.split(',').length;
        showToast('info', `${totalDocs}个文档推送已开始，后台处理中...`);
        
        // 轮询进度
        if (data.task_id) {
          pollBatchProgress(data.task_id);
        }
      } else {
        completeProgress(); // 隐藏进度条
        showError(data.message || '推送失败');
      }
    })
    .catch(error => {
      pushBtn.disabled = false;
      pushBtn.innerHTML = '<i class="fas fa-cloud-upload-alt me-2"></i>推送';
      completeProgress(); // 隐藏进度条
      showError('推送失败: ' + error.message);
    });
  });
  
  // 轮询批量处理进度
  function pollBatchProgress(taskId) {
    // 保存当前批次的文档ID
    const docIds = document.getElementById('batchDifyDocumentIds').value.split(',');
    
    let pollInterval = setInterval(() => {
      fetch(`/chunklab/dify/batch-status/${taskId}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'completed') {
            updateProgress(100);
            completeProgress();
            clearInterval(pollInterval);
            
            // 所有文档都处理完成，更新为"已推送"
            docIds.forEach(id => {
              updatePushStatus(id, 'pushed');
            });
            
            showToast('success', `批量处理完成: ${data.success_count}个成功, ${data.error_count}个失败`);
            setTimeout(() => window.location.reload(), 2000);
          } else if (data.status === 'error') {
            completeProgress();
            clearInterval(pollInterval);
            showToast('error', '批量处理失败: ' + data.message);
          } else if (data.status === 'processing') {
            // 更新进度条
            const percent = (data.processed_count / data.total_count) * 100;
            updateProgress(percent);
          }
        })
        .catch(() => {
          // 出错时不中断轮询，继续尝试
        });
    }, 3000); // 每3秒轮询一次
    
    // 超时处理 - 3分钟后停止轮询
    setTimeout(() => {
      if (pollInterval) {
        clearInterval(pollInterval);
        completeProgress();
      }
    }, 180000);
  }
  
  // 更新推送状态的辅助函数 - 只影响推送状态标签
  function updatePushStatus(docId, status) {
    // 查找checkbox，通过它找到对应的文档项
    const checkbox = document.getElementById(`doc${docId}`);
    if (checkbox) {
      // 找到checkbox所在的文档项
      const docItem = checkbox.closest('.document-item');
      if (docItem) {
        // 查找带有dify-push-status类的元素
        const pushStatusEl = docItem.querySelector('.dify-push-status');
        if (pushStatusEl) {
          // 更新样式类
          pushStatusEl.classList.remove('status-chunked', 'status-processing', 'status-pending');
          
          if (status === 'pushing') {
            pushStatusEl.classList.add('status-processing');
            pushStatusEl.textContent = '推送中';
          } else if (status === 'pushed') {
            pushStatusEl.classList.add('status-chunked');
            pushStatusEl.textContent = '已推送';
          } else {
            pushStatusEl.classList.add('status-pending');
            pushStatusEl.textContent = '未推送';
          }
        }
      }
    }
  }
});
</script> 